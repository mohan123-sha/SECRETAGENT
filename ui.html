<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Design System Plugin</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 16px;
      padding: 0;
    }
    
    .mode-tabs {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .tab {
      flex: 1;
      padding: 8px 16px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #666;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      color: #0066cc;
      border-bottom-color: #0066cc;
    }
    
    .mode-content {
      display: none;
    }
    
    .mode-content.active {
      display: block;
    }
    
    #prompt-input {
      width: 100%;
      height: 80px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }
    
    .btn {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .btn:hover {
      background-color: #0052a3;
    }
    
    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .btn.secondary {
      background-color: #64748B;
    }
    
    .btn.secondary:hover {
      background-color: #475569;
    }
    
    #status {
      margin-top: 12px;
      font-size: 12px;
      color: #666;
    }
    
    .compliance-score {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 4px;
      text-align: center;
    }
    
    .compliance-good {
      background-color: #d4edda;
      color: #155724;
    }
    
    .compliance-warning {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .compliance-poor {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .violation {
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
      background-color: #f9f9f9;
    }
    
    .violation-issue {
      font-weight: bold;
      color: #d73a49;
      margin-bottom: 4px;
    }
    
    .violation-expected {
      color: #666;
      font-size: 12px;
      margin-bottom: 4px;
    }
    
    .error-message {
      color: #d73a49;
      background-color: #f8d7da;
      padding: 12px;
      border-radius: 4px;
      margin-top: 12px;
    }
    
    .validation-results {
      margin-top: 16px;
    }
    
    .validation-status {
      padding: 12px;
      border-radius: 4px;
      margin-top: 12px;
      font-size: 14px;
    }
    
    .validation-status.valid {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .validation-status.invalid {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .validation-score {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .validation-errors {
      margin-top: 8px;
    }
    
    .validation-error {
      background-color: #fff5f5;
      border: 1px solid #fed7d7;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 4px;
      font-size: 12px;
      color: #c53030;
    }
  </style>
</head>
<body>
  <div class="mode-tabs">
    <button class="tab active" data-mode="generator">Generator</button>
    <button class="tab" data-mode="validator">Validator</button>
  </div>

  <!-- Generator Mode -->
  <div id="generator-mode" class="mode-content active">
    <textarea 
      id="prompt-input" 
      placeholder="Describe your screen (e.g., Create a login screen with email input, password input, and a sign in button)"
    ></textarea>
    
    <div style="margin: 12px 0;">
      <label style="display: flex; align-items: center; font-size: 14px; color: #333;">
        <input type="checkbox" id="generate-code-checkbox" style="margin-right: 8px;">
        Generate Angular + PrimeNG code
      </label>
    </div>
    
    <div style="margin: 12px 0;">
      <label style="display: block; font-size: 14px; color: #333; margin-bottom: 4px;">
        Screen Name (optional):
      </label>
      <input 
        type="text" 
        id="screen-name-input" 
        placeholder="e.g., Login, Dashboard, Profile"
        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
      >
    </div>
    
    <button id="generate-btn" class="btn">Generate Design</button>
    
    <button id="generate-from-design-btn" class="btn secondary" style="margin-top: 8px;">Generate Code from Current Design</button>
    
    <div style="margin: 12px 0; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 12px; color: #1976d2;">
      <strong>üí° Selection-Based Generation:</strong> Select any frame or component in Figma, then click the button below to generate Angular code for that specific component only.
    </div>
    
    <button id="scan-library-btn" class="btn" style="margin-top: 8px; background-color: #059669;">Generate from Selection</button>
    
    <div id="validation-status" style="margin-top: 12px; display: none;"></div>
    
    <div id="status"></div>
    <div id="code-results" style="margin-top: 16px;"></div>
  </div>

  <!-- Validator Mode -->
  <div id="validator-mode" class="mode-content">
    <p style="color: #666; font-size: 14px; margin-bottom: 16px;">
      Select any frame or element inside a frame and click "Validate Design" to check compliance with design system rules.
    </p>
    
    <button id="validate-btn" class="btn secondary">Validate Design</button>
    
    <div id="validation-results" class="validation-results"></div>
  </div>

  <script>
    const promptInput = document.getElementById('prompt-input');
    const generateBtn = document.getElementById('generate-btn');
    const generateFromDesignBtn = document.getElementById('generate-from-design-btn');
    const scanLibraryBtn = document.getElementById('scan-library-btn');
    const generateCodeCheckbox = document.getElementById('generate-code-checkbox');
    const screenNameInput = document.getElementById('screen-name-input');
    const validateBtn = document.getElementById('validate-btn');
    const status = document.getElementById('status');
    const validationStatus = document.getElementById('validation-status');
    const codeResults = document.getElementById('code-results');
    const validationResults = document.getElementById('validation-results');
    const tabs = document.querySelectorAll('.tab');
    const modeContents = document.querySelectorAll('.mode-content');

    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const mode = tab.dataset.mode;
        
        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active content
        modeContents.forEach(content => content.classList.remove('active'));
        document.getElementById(`${mode}-mode`).classList.add('active');
      });
    });

    // Generator mode
    generateBtn.addEventListener('click', () => {
      const userPrompt = promptInput.value.trim();
      
      if (!userPrompt) {
        status.textContent = 'Please enter a screen description';
        return;
      }
      
      // Update UI state
      generateBtn.disabled = true;
      status.textContent = 'Generating...';
      codeResults.innerHTML = ''; // Clear previous code results
      validationStatus.style.display = 'none'; // Hide validation status
      
      // Get code generation options
      const generateCode = generateCodeCheckbox.checked;
      const screenName = screenNameInput.value.trim() || null;
      
      console.log('[UI] Sending generation request:', { 
        userPrompt, 
        generateCode, 
        screenName 
      });
      
      // Send message to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'generate-design',
          userPrompt: userPrompt,
          generateCode: generateCode,
          screenName: screenName
        }
      }, '*');
    });

    // Generate Code from Current Design
    generateFromDesignBtn.addEventListener('click', () => {
      console.log('[UI] Generate from current design clicked');
      
      // Update UI state
      generateFromDesignBtn.disabled = true;
      generateFromDesignBtn.textContent = 'Validating Design...';
      codeResults.innerHTML = ''; // Clear previous results
      validationStatus.style.display = 'none'; // Hide previous validation
      
      // Get screen name for code generation
      const screenName = screenNameInput.value.trim() || null;
      
      console.log('[UI] Sending validate-and-generate request:', { screenName });
      
      // Send message to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'validate-and-generate',
          screenName: screenName
        }
      }, '*');
    });

    // Validator mode
    validateBtn.addEventListener('click', () => {
      console.log("üîç UI: Validate button clicked");
      validateBtn.disabled = true;
      validateBtn.textContent = 'Validating...';
      validationResults.innerHTML = '<p style="color: #666;">Running validation...</p>';
      
      // Send message to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'validate-design'
        }
      }, '*');
      
      console.log("üì§ UI: Validation message sent to plugin");
    });

    // Generate from Selection (Production-Safe)
    scanLibraryBtn.addEventListener('click', () => {
      console.log('[UI] Generate from Selection clicked');
      
      // Update UI state
      scanLibraryBtn.disabled = true;
      scanLibraryBtn.textContent = 'Checking Selection...';
      codeResults.innerHTML = ''; // Clear previous results
      
      console.log('[UI] Sending scan-library-storybook request (selection-based)');
      
      // Send message to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'scan-library-storybook'
        }
      }, '*');
    });

    // Listen for messages from plugin
    window.onmessage = (event) => {
      const { type, message, violations, complianceScore, frameName, score, files, screenName } = event.data.pluginMessage || {};
      
      console.log("üì• UI: Received message from plugin:", { type, score, violationsCount: violations && violations.length });
      
      if (type === 'status-update') {
        status.textContent = message;
        generateBtn.disabled = false;
        console.log("‚úÖ UI: Generator status updated");
        
      } else if (type === 'code-generated') {
        console.log('[UI] End-to-end pipeline completed:', { 
          files: files && files.length, 
          screenName, 
          writtenFiles: event.data.pluginMessage.writtenFiles && event.data.pluginMessage.writtenFiles.length,
          smartDocs: event.data.pluginMessage.smartDocumentation ? 'Generated' : 'None'
        });
        
        const { writtenFiles, smartDocumentation, pipeline } = event.data.pluginMessage;
        
        // Display comprehensive pipeline results
        if (files && files.length > 0) {
          let codeHTML = `
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 16px; margin-top: 16px;">
              <h4 style="margin: 0 0 12px 0; color: #28a745;">üéâ End-to-End Pipeline Completed</h4>
              <p style="margin: 0 0 12px 0; font-size: 14px; color: #666;">
                <strong>${screenName || 'Component'}</strong> generated successfully with complete documentation:
              </p>
              
              <div style="margin: 12px 0;">
                <h5 style="margin: 0 0 8px 0; color: #495057;">üìÅ Files Created:</h5>
                <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #333;">
          `;
          
          // Show written files (actual files on disk)
          if (writtenFiles && writtenFiles.length > 0) {
            writtenFiles.forEach(file => {
              const fileName = file.path ? file.path.split('\\').pop() : 'unknown';
              codeHTML += `<li>${fileName} <span style="color: #666;">(${file.size} chars)</span></li>`;
            });
          } else {
            // Fallback to export files
            files.forEach(file => {
              const fileName = file.path ? file.path.split('/').pop() : 'unknown';
              codeHTML += `<li>${fileName}</li>`;
            });
          }
          
          codeHTML += `</ul></div>`;
          
          // Show Smart Documentation results
          if (smartDocumentation) {
            codeHTML += `
              <div style="margin: 12px 0;">
                <h5 style="margin: 0 0 8px 0; color: #495057;">üìö Smart Documentation:</h5>
                <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #333;">
                  <li>Component analyzed: <strong>${(smartDocumentation.analyzer && smartDocumentation.analyzer.componentName) || 'Unknown'}</strong></li>
                  <li>Documentation IR: <strong>doc-ir.json</strong> updated</li>
                  <li>Storybook story: <strong>${(smartDocumentation.storybook && smartDocumentation.storybook.fileName) || 'component.stories.ts'}</strong> created</li>
                </ul>
              </div>
            `;
          }
          
          // Show pipeline steps
          if (pipeline) {
            codeHTML += `
              <div style="margin: 12px 0;">
                <h5 style="margin: 0 0 8px 0; color: #495057;">‚ö° Pipeline Steps:</h5>
                <div style="font-size: 14px; color: #333;">
                  ${(pipeline.step1_codeGeneration && pipeline.step1_codeGeneration.success) ? '‚úÖ' : '‚ùå'} Code Generation
                  ${(pipeline.step2_fileWriting && pipeline.step2_fileWriting.success) ? '‚Üí ‚úÖ' : '‚Üí ‚ùå'} File Writing
                  ${(pipeline.step3_smartDocs && pipeline.step3_smartDocs.success) ? '‚Üí ‚úÖ' : '‚Üí ‚ùå'} Smart Documentation
                </div>
              </div>
            `;
          }
          
          codeHTML += `
              <p style="margin: 12px 0 0 0; font-size: 12px; color: #666;">
                All files saved to: <code>generated-components/${(screenName || 'component').toLowerCase()}/</code>
              </p>
            </div>
          `;
          
          codeResults.innerHTML = codeHTML;
        }
        
      } else if (type === 'code-generation-error') {
        console.log('[UI] Code generation error:', event.data.pluginMessage.error);
        
        codeResults.innerHTML = `
          <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 16px; margin-top: 16px;">
            <h4 style="margin: 0 0 8px 0; color: #721c24;">‚ùå Code Generation Failed</h4>
            <p style="margin: 0; font-size: 14px; color: #721c24;">
              ${event.data.pluginMessage.error}
            </p>
          </div>
        `;
        
      } else if (type === 'validation-result') {
        console.log("üìä UI: Processing validation result");
        validateBtn.disabled = false;
        validateBtn.textContent = 'Validate Design';
        
        // Display compliance score
        let scoreClass = 'compliance-good';
        if (score < 80) scoreClass = 'compliance-warning';
        if (score < 60) scoreClass = 'compliance-poor';
        
        let resultsHTML = `
          <div class="compliance-score ${scoreClass}">
            Design Compliance: ${score}%
          </div>
        `;
        
        if (violations.length === 0) {
          resultsHTML += '<p style="color: #28a745; text-align: center;">‚úÖ Design is compliant! No violations found.</p>';
        } else {
          resultsHTML += `<p style="margin-bottom: 16px;"><strong>${violations.length} violation${violations.length > 1 ? 's' : ''} found:</strong></p>`;
          
          violations.forEach((violation, index) => {
            resultsHTML += `
              <div class="violation">
                <div class="violation-issue"><strong>${violation.nodeName}:</strong> ${violation.message}</div>
                <div class="violation-expected"><strong>Rule:</strong> ${violation.rule}</div>
                <div class="violation-expected"><strong>Suggestion:</strong> ${violation.suggestion}</div>
              </div>
            `;
          });
        }
        
        validationResults.innerHTML = resultsHTML;
        console.log("‚úÖ UI: Validation results displayed");
        
      } else if (type === 'validation-scope-update') {
        console.log("üìç UI: Validation scope update received");
        
        // Show validation scope in validator mode
        if (document.getElementById('validator-mode').classList.contains('active')) {
          const scopeMessage = event.data.pluginMessage.message;
          const existingResults = validationResults.innerHTML;
          
          validationResults.innerHTML = `
            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; padding: 12px; margin-bottom: 16px; color: #1976d2;">
              <strong>üìç ${scopeMessage}</strong>
            </div>
            ${existingResults}
          `;
        }
        
      } else if (type === 'design-validation-result') {
        console.log("üìä UI: Processing design validation result for code generation");
        
        const { valid, score, errors, warnings } = event.data.pluginMessage;
        
        // Show validation status
        validationStatus.style.display = 'block';
        validationStatus.className = `validation-status ${valid ? 'valid' : 'invalid'}`;
        
        let statusHTML = `<div class="validation-score">Design Score: ${score} / 100</div>`;
        
        if (valid) {
          statusHTML += `
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <span style="color: #28a745; margin-right: 8px;">‚úÖ</span>
              <span>Design validated. Generating code...</span>
            </div>
          `;
        } else {
          statusHTML += `
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <span style="color: #dc3545; margin-right: 8px;">‚ùå</span>
              <span>Design validation failed. Code generation blocked.</span>
            </div>
          `;
          
          if (errors && errors.length > 0) {
            statusHTML += '<div class="validation-errors">';
            errors.forEach(error => {
              statusHTML += `<div class="validation-error">${error}</div>`;
            });
            statusHTML += '</div>';
          }
        }
        
        validationStatus.innerHTML = statusHTML;
        
        // Reset button state
        generateFromDesignBtn.disabled = false;
        generateFromDesignBtn.textContent = 'Generate Code from Current Design';
        
        console.log("‚úÖ UI: Design validation results displayed");
        
      } else if (type === 'selection-error') {
        console.log('[UI] Selection error:', event.data.pluginMessage);
        
        // Reset button state
        scanLibraryBtn.disabled = false;
        scanLibraryBtn.textContent = 'Generate from Selection';
        
        // Display selection error
        codeResults.innerHTML = `
          <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 16px; margin-top: 16px;">
            <h4 style="margin: 0 0 8px 0; color: #856404;">‚ö†Ô∏è Selection Required</h4>
            <p style="margin: 0 0 12px 0; font-size: 14px; color: #856404;">
              ${event.data.pluginMessage.message}
            </p>
            <p style="margin: 0; font-size: 12px; color: #856404;">
              <strong>How to use:</strong> Select a frame, component, or component instance in Figma, then click "Generate from Selection"
            </p>
          </div>
        `;
        
      } else if (type === 'selection-generation-complete') {
        console.log('[UI] Selection generation completed:', event.data.pluginMessage);
        
        const { componentName, selectedNodeName, selectedNodeType, detectedComponentType } = event.data.pluginMessage;
        
        // Reset button state
        scanLibraryBtn.disabled = false;
        scanLibraryBtn.textContent = 'Generate from Selection';
        
        // Display success message
        codeResults.innerHTML = `
          <div style="background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 4px; padding: 16px; margin-top: 16px;">
            <h4 style="margin: 0 0 12px 0; color: #065f46;">‚úÖ Component Generated from Selection</h4>
            <p style="margin: 0 0 8px 0; font-size: 14px; color: #065f46;">
              Successfully generated <strong>${componentName}</strong> from selected ${selectedNodeType.toLowerCase()}: "${selectedNodeName}"
            </p>
            <p style="margin: 0 0 12px 0; font-size: 13px; color: #065f46;">
              <strong>Detected Type:</strong> ${detectedComponentType || 'primary_button'}
            </p>
            <p style="margin: 0; font-size: 12px; color: #065f46;">
              Files saved to: <code>generated-components/${componentName.toLowerCase()}/</code>
            </p>
          </div>
        `;
        
      } else if (type === 'selection-generation-error') {
        console.log('[UI] Selection generation error:', event.data.pluginMessage);
        
        // Reset button state
        scanLibraryBtn.disabled = false;
        scanLibraryBtn.textContent = 'Generate from Selection';
        
        // Display error message
        codeResults.innerHTML = `
          <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 16px; margin-top: 16px;">
            <h4 style="margin: 0 0 8px 0; color: #721c24;">‚ùå Generation Failed</h4>
            <p style="margin: 0; font-size: 14px; color: #721c24;">
              ${event.data.pluginMessage.error}
            </p>
          </div>
        `;
        
      } else if (type === 'library-scan-blocked') {
        console.log('[UI] Library scan blocked:', event.data.pluginMessage);
        
        // Reset button state
        scanLibraryBtn.disabled = false;
        scanLibraryBtn.textContent = 'Generate from Selection';
        
        // Display blocked message
        codeResults.innerHTML = `
          <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 16px; margin-top: 16px;">
            <h4 style="margin: 0 0 8px 0; color: #721c24;">üö® Library Scanning Disabled</h4>
            <p style="margin: 0 0 12px 0; font-size: 14px; color: #721c24;">
              ${event.data.pluginMessage.message}
            </p>
            <p style="margin: 0; font-size: 12px; color: #721c24;">
              <strong>Recommendation:</strong> ${event.data.pluginMessage.recommendation}
            </p>
          </div>
        `;
        
      } else if (type === 'library-scan-complete') {
        console.log('[UI] Library scan completed:', event.data.pluginMessage);
        
        const { componentCount, registry } = event.data.pluginMessage;
        
        // Reset button state
        scanLibraryBtn.disabled = false;
        scanLibraryBtn.textContent = 'Generate from Selection';
        
        // Display library scan results
        let resultsHTML = `
          <div style="background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 4px; padding: 16px; margin-top: 16px;">
            <h4 style="margin: 0 0 12px 0; color: #065f46;">üìö Library Scan Completed</h4>
            <p style="margin: 0 0 12px 0; font-size: 14px; color: #065f46;">
              Found <strong>${componentCount}</strong> components in your Figma library
            </p>
        `;
        
        if (registry && registry.length > 0) {
          // Group by category
          const categoryCounts = {};
          registry.forEach(comp => {
            categoryCounts[comp.category] = (categoryCounts[comp.category] || 0) + 1;
          });
          
          resultsHTML += `
            <div style="margin: 12px 0;">
              <h5 style="margin: 0 0 8px 0; color: #065f46;">üìÇ Components by Category:</h5>
              <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #065f46;">
          `;
          
          Object.entries(categoryCounts).forEach(([category, count]) => {
            resultsHTML += `<li>${category}: ${count} component${count > 1 ? 's' : ''}</li>`;
          });
          
          resultsHTML += `</ul></div>`;
        }
        
        resultsHTML += `
            <p style="margin: 12px 0 0 0; font-size: 12px; color: #065f46;">
              Design System Portal ready at: <code>http://localhost:6006</code>
            </p>
          </div>
        `;
        
        codeResults.innerHTML = resultsHTML;
        
      } else {
        console.log("‚ùì UI: Unknown message type:", type);
      }
    };
  </script>
</body>
</html>